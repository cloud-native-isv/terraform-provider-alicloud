# Feature Specification: 自动接管已存在数据库（alicloud_db_database）

**Feature Branch**: `006-support-exist-resource`  
**Created**: 2025-10-31  
**Status**: Draft  
**Input**: User description: "support exist resource_alicloud_db_database: 当前创建alicloud_db_database资源的时候如果database已经存在则会保存，需要改成如果已经存在就直接import"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 已存在数据库应被自动接管（Priority: P1）

当用户在目标实例内以某个名称声明创建数据库，但该数据库已存在时，系统应自动将该数据库接入为受管对象（即采纳为当前配置的管理对象），而不是重复创建或静默“保存”。

**Why this priority**: 避免重复创建与脏状态，保障基础设施即代码的幂等性与用户信任，影响面广且为主路径。

**Independent Test**: 仅通过准备“实例内已存在同名数据库”的前置条件，执行一次变更，验证变更完成后资源处于受管状态且未产生重复对象。

**Acceptance Scenarios**:

1. Given 目标实例内已存在名称为 X 的数据库，When 用户声明创建名称为 X 的数据库并执行变更，Then 变更完成，系统提示“已接管现有数据库”，且不创建新数据库。
2. Given 上述接管已完成，When 再次执行计划与变更，Then 计划显示无改动（No-op），变更无操作完成。
3. Given 目标实例内已存在名称为 X 的数据库，When 用户先执行计划（Plan），Then 计划输出中明确显示“将接管已存在的数据库 X（位于实例 Y）”，以便用户在应用前即知晓即将发生的接管行为。

---

### User Story 2 - 配置与现状差异的处理（Priority: P2）

当现有数据库与用户配置在不可变关键属性上存在差异时，系统需给出清晰可验证的结果：要么阻止并给出可理解的错误，要么在可变字段范围内进行安全对齐，确保用户对最终状态有明确预期。

**Why this priority**: 明确差异处理策略可避免误改，保障数据安全与合规，减少支持成本。

**Independent Test**: 为现有数据库设置与配置不一致的属性，执行一次变更，验证系统的差异处理与反馈是否符合约定策略。

**Acceptance Scenarios**:

1. Given 现有数据库的不可变属性与配置不一致（如字符集），When 用户执行变更，Then 系统中止并给出明确错误，指明冲突字段与下一步指引（采用“失败 + 指引”的保守策略）。
2. Given 现有数据库的可变属性与配置不一致（如描述），When 用户执行变更，Then 在本次接管中系统仅完成“接管”而不修改现有数据库；同时明确提示如何在后续变更中对齐（默认不在接管同一轮自动对齐可变属性）。

---

### User Story 3 - 权限与可见性（Priority: P3）

当数据库存在但用户权限不足（读取/列举受限）时，系统需提供一致的用户体验：明确告知原因与所需权限，避免误导性的“已创建/已保存”。

**Why this priority**: 权限问题常见且影响判断，需减少误导与反复试错。

**Independent Test**: 通过受限权限账户执行一次变更，验证系统能准确指示“资源已存在但不可接管”的原因与所需权限。

**Acceptance Scenarios**:

1. Given 资源存在且用户仅具备有限权限，When 执行变更，Then 系统给出权限不足的明确提示与需要的最小权限说明。

### Edge Cases

- 同名数据库在短时间内被外部系统创建/删除的竞争条件（race condition）应被稳健处理（重试/最终一致的判断与提示）。
- 数据库处于不可用/冻结/只读等临时状态时的接管行为（等待、失败、提示）。
- 目标实例不匹配（配置的实例与资源实际所在实例不同）的跨实例同名冲突识别与提示。
- 已存在但处于回收/软删除窗口中的特殊状态处理与用户反馈。
- 多区域/多实例下的唯一性与范围界定（仅在目标实例上下文内判断存在性）。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 当目标实例内已存在声明名称的数据库时，系统必须自动将其接管为受管对象，而非创建重复数据库或仅“保存”现状。
- **FR-002**: 接管流程必须幂等；完成接管后再次计划/变更应显示无差异且无操作。
- **FR-003**: 对不可变关键属性（如字符集、排序规则等）的差异，系统必须采用“失败 + 指引”的保守策略，并提供清晰错误与后续操作建议；认定同一数据库的最小匹配集合为“实例标识 + 数据库名”。
- **FR-004**: 对可变属性（如描述、标签）的差异，系统在“接管”发生的同一轮变更中默认不自动对齐，只提示如何对齐；对齐应在后续明确的变更中执行（用户可在下一次变更中完成对齐）。
- **FR-005**: 在接管发生时，系统必须提供明确的用户可见说明，指出“检测到现有数据库并已接管”，避免产生“已创建”的误导。
- **FR-006**: 当资源存在但因权限不足无法完成接管时，系统必须提示所需最小权限与下一步操作建议。
- **FR-007**: 在异常与竞争条件下（例如短暂的可见性不一致、限流、系统繁忙），系统必须采取有限重试与可恢复反馈，确保用户得到稳定一致的结果。
- **FR-008**: 接管不得对现有数据库造成破坏性变更；任何潜在破坏性的调整必须被阻止并以清晰错误提示用户后续选项。

- **FR-009**: 在计划阶段（Plan）若检测到目标实例内已存在同名数据库，计划输出必须清晰标注“将接管已存在的数据库”，并包含数据库名与实例标识，提升透明度与可预测性。

### Key Entities *(include if feature involves data)*

- **Database（数据库）**: 标识（实例、名称）、属性（字符集、排序规则、描述、标签、状态）与所有权范围（所属实例/地域）。
- **Desired Configuration（期望配置）**: 用户声明的数据库目标属性集合，用于接管或校验差异。
- **Adoption Outcome（接管结果）**: 是否接管、接管时间、差异摘要、后续建议/指引。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 对已存在数据库的变更请求，100% 在一次变更流程内完成接管且不创建重复对象。
- **SC-002**: 接管路径下，90% 请求在 2 分钟内完成，99% 在 5 分钟内完成（含必要的状态轮询/重试）。
- **SC-003**: 接管完成后的二次计划显示“无改动”的比例≥95%；其余因冲突被阻止的场景提供可执行的清晰指引。
- **SC-004**: 与“重复创建/误导提示”相关的支持请求在功能上线后 30 天内降低 ≥50%。
- **SC-005**: 用户可理解性（基于内部可用性验证）：80% 以上的用户在首次接触时无需外部文档即可判断接管结果与下一步操作。

## Assumptions

- 同名唯一性的判断范围限定在“目标数据库实例内”。
- “不可变属性”以主流云数据库的通行约束为准（如字符集通常不可在线变更）。
- 用户具备查看数据库列表与属性所需的最小权限；若不具备则以“权限不足”路径反馈并不中断其它资源评估。

